<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.huangtl.blogmgr.model.blog.Privilege">

	<resultMap id="mapper" type="com.huangtl.blogmgr.model.blog.Privilege" >
		<id property="fId" column="pri_id"/>
		<result property="fPriority" column="dic_auth_priority"/>
		<result property="fFunId" column="fn_id" />
		<result property="fRoleId" column="rol_id"/>
		<result property="fType" column="dic_type"/>
		
		<result property="funDescr" column="fn_Descr"/>
		<result property="funName" column="fn_Name"/>
		<result property="funParentId" column="fn_ParentId"/>
		<result property="funHandler" column="fn_Handler"/>
		<result property="funRelevance" column="fn_Relevance"/>
		<result property="funIcon" column="fn_Icon"/>
		<result property="funOrder" column="fn_Order"/>
		<result property="funGlyph" column="fn_Glyph"/>
		<result property="funType" column="fn_Type"/>
		<result property="funUsability" column="fn_Usability"/>
	</resultMap>
	
	<sql id="field">
		pri_id ,dic_auth_priority ,fn_id ,rol_id,
		fn_Name ,fn_Descr ,fn_ParentId,fn_Handler,fn_Glyph,fn_Usability
		<if test="fType_show != null">,dic_type</if>
		<if test="funType_show != null">,fn_Type</if>
		<if test="funOrder_show != null">,fn_Order</if>
		<if test="funIcon_show != null">,fn_Icon</if>
		<if test="funRelevance_show != null">,fn_Relevance</if>
		<if test="funDescr_show != null">,fn_Descr</if>
	</sql>
	
	<sql id="where">
		 <trim prefix="where" prefixOverrides="and|or">
		 	<if test="defaultWhere!=null and defaultWhere">1=1</if>
			<if test="fType_eq !=null ">and dic_type = #{fType_eq}</if>
			<if test="fPriority_eq != null">and dic_auth_priority = #{fPriority_eq}</if>
			<if test="fPriority_ne != null">and dic_auth_priority != #{fPriority_ne}</if>
			<if test="fId_eq != null">and pri_id = #{fId_eq}</if>
			<if test="fRoleId_eq != null">and rol_id = #{fRoleId_eq}</if>
			<if test="fFunId_eq != null">and fn_id= #{fFunId_eq}</if>
			<if test="funParentId_eq != null">and fn_ParentId = #{funParentId_eq}</if>
			<if test="funType_eq != null">and fn_Type = #{funType_eq}</if>
			<if test="fRoleId_in != null">
				and rol_id in
				<foreach collection="fRoleId_in" open="(" item="roleIdItem" separator="," close=")">
					#{roleIdItem}
				</foreach>
			</if>
			<if test="fPriority_in != null">
				and dic_auth_priority in 
				<foreach collection="fPriority_in" open="(" item="priorityItem" separator="," close=")">
					#{priorityItem}
				</foreach>
			</if>
		</trim>
	</sql>
	
	<sql id="order">
		<if test="sorts != null and sorts.size() != 0">
			order by 
			<foreach collection="sorts" separator="," index="key" item="val">
				${key} ${val}
			</foreach>
		</if>
	</sql>
	
	
	<select id="selectList" resultMap="mapper" parameterType="map">
		select 
			<include refid="field"/>
		from 
			(select fn_Descr,fn_Name,fn_id as fnId,fn_ParentId,fn_Handler,fn_Glyph,dic_Usability as fn_Usability,
			   dic_Type as fn_Type,fn_Order,fn_Icon,fn_Relevance
			   from mgr_function where dic_Usability = 'ENABLE') a 
			left join mgr_privilege b on a.fnId = b.fn_id
			<include refid="where"/>
	</select>
	
	<select id="selectCount"  resultType="long" parameterType="map">
	  select count(pri_id) 
	 	from mgr_privilege
		<include refid="where"/>
	</select>
	
	<select id="selectPaging" resultMap="mapper" parameterType="map">
		select 
			<include refid="field"/>
		from 
			(select fn_Descr,fn_Name,fn_id as fnId,fn_ParentId,fn_Handler,fn_Glyph,dic_Usability as fn_Usability,
			   dic_Type as fn_Type,fn_Order,fn_Icon,fn_Relevance
			   from mgr_function where dic_Usability = 'ENABLE') a 
			left join mgr_privilege b on a.fn_Id = b.fn_id
			<include refid="where"/>
			<include refid="order"/>
		limit #{startIndex},#{pageSize}
	</select>
	
	
	<select id="selectUnionPrivilege" resultMap="mapper" parameterType="map">
			select 
				<include refid="field"/>
			from 
				(select 
					fn_Id as funId ,fn_Name,fn_ParentId,fn_Handler,fn_Glyph,fn_Order,dic_Usability as fn_Usability,fn_Descr,
					dic_Type as fn_Type,fn_Icon,fn_Relevance
				from mgr_function where dic_Usability = 'ENABLE') a
				left join (
					 select pri_id, fn_id,dic_auth_priority,rol_id from mgr_privilege a
					 where 
					 pri_id = (
						select pri_id from  mgr_privilege b
						left join (
							select * from sys_dictionary
							where dt_type = 'AuthPriority'
						) c on b.dic_auth_priority = c.dic_id
						where b.fn_id = a.fn_id
						and b.rol_id in
						<foreach collection="fRoleId_in" open="(" item="roleIdItem" separator="," close=")">
							#{roleIdItem}
						</foreach>
						order by dic_code asc
						limit 1
					 )
				)b on a.funId = b.fn_id
			<include refid="where"/>
			order by fn_Order
	</select> 
	
	<insert id="insert" parameterType="com.huangtl.blogmgr.model.blog.Privilege">
		insert into mgr_privilege(
			pri_id,dic_auth_priority,fn_id,rol_id,dic_type
		) values(
			#{fId},#{fPriority},#{fFunId},#{fRoleId},#{fType}
		);
	</insert>
	
	<update id="update" parameterType="map">
		update mgr_privilege 
		<trim prefix="set" suffixOverrides=",">
			<if test="fPriority !=null">dic_auth_priority = #{fPriority},</if>
			<if test="fType !=null">dic_type = #{fType},</if>
		</trim>
		<include refid="where"/>
	</update>
	
	 <update id="updateBatch" parameterType="list">
		<foreach collection="list" item="privilege" index="index" open="" close="" separator=";">
			update mgr_privilege 
			<trim prefix="set" suffixOverrides=",">
				<if test="privilege.fPriority !=null">dic_auth_priority = #{privilege.fPriority},</if>
			</trim>
			 where pri_id = #{privilege.fId}
		</foreach>
	</update> 
	
</mapper>